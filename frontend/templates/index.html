<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Computing Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Quantum Computing Assistant</h1>
            <p>Powered by a custom 125.8M parameter transformer</p>
        </header>

        <div class="chat" id="chat">
            <!-- Welcome screen (shown initially) -->
            <div class="welcome" id="welcome">
                <div class="welcome__icon">
                    <div class="atom">
                        <div class="atom__nucleus"></div>
                        <div class="atom__orbit atom__orbit--1"></div>
                        <div class="atom__orbit atom__orbit--2"></div>
                        <div class="atom__orbit atom__orbit--3"></div>
                    </div>
                </div>
                
                <h2 class="welcome__title">Welcome!</h2>
                
                <p class="welcome__text">
                    Ask me anything about quantum computing. I'm here to help explain 
                    concepts like qubits, superposition, entanglement, and more.
                </p>

                <div class="welcome__disclaimer">
                    <strong>⚠️ Please note:</strong> This app runs on a free-tier server with a 
                    custom 125.8M parameter model running on CPU. Response times are typically 
                    <strong>40-90 seconds</strong>. Thank you for your patience!
                </div>

                <div class="welcome__starters">
                    <p class="welcome__starters-label">Try one of these questions:</p>
                    <div class="welcome__starters-grid">
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is a qubit?')">What is a qubit?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is superposition?')">What is superposition?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is quantum entanglement?')">What is quantum entanglement?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is a quantum gate?')">What is a quantum gate?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('Why is quantum computing important?')">Why is quantum computing important?</button>
                    </div>
                </div>
            </div>

            <!-- Messages container (hidden initially) -->
            <div class="messages" id="messages"></div>
        </div>

        <form class="input-bar" id="input-form" onsubmit="handleSubmit(event)">
            <input
                type="text"
                class="input-bar__input"
                id="input-field"
                placeholder="Ask a question about quantum computing..."
                autocomplete="off"
            >
            <button type="submit" class="input-bar__button" id="send-btn">Send</button>
        </form>
    </div>

    <script>
        // State
        let isLoading = false;
        let hasMessages = false;

        // Loading messages and facts
        const LOADING_MESSAGES = [
            "Searching knowledge base...",
            "Retrieving relevant context...",
            "Preparing quantum insights...",
            "Generating response...",
            "Almost there...",
            "Processing with 125.8M parameters...",
            "Analyzing quantum concepts...",
            "Formulating answer..."
        ];

        const QUANTUM_FACTS = [
            "A quantum computer with 300 qubits could represent more states than there are atoms in the observable universe.",
            "Quantum entanglement was called 'spooky action at a distance' by Einstein.",
            "The first quantum computer was built in 1998 with just 2 qubits.",
            "Quantum computers must be kept at temperatures colder than outer space.",
            "Google's Sycamore processor achieved quantum supremacy in 2019.",
            "Quantum computers could break most current encryption methods.",
            "Superposition allows a qubit to be 0 and 1 simultaneously."
        ];

        // DOM elements
        const chat = document.getElementById('chat');
        const welcome = document.getElementById('welcome');
        const messages = document.getElementById('messages');
        const inputField = document.getElementById('input-field');
        const sendBtn = document.getElementById('send-btn');

        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            const question = inputField.value.trim();
            if (question && !isLoading) {
                sendQuestion(question);
                inputField.value = '';
            }
        }

        // Send a question to the API
        async function sendQuestion(question) {
            if (isLoading) return;

            // Hide welcome, show messages
            if (!hasMessages) {
                welcome.style.display = 'none';
                messages.style.display = 'flex';
                hasMessages = true;
            }

            // Add user message
            addMessage('user', question);

            // Show loading
            setLoading(true);
            const loadingEl = addLoadingIndicator();

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                // Remove loading indicator
                loadingEl.remove();

                if (response.ok) {
                    addMessage('ai', data.answer, data.response_time_ms, data.suggested_question);
                } else {
                    addMessage('error', data.error || 'Something went wrong. Please try again.');
                }
            } catch (error) {
                loadingEl.remove();
                addMessage('error', 'Failed to connect. Is the backend running?');
            } finally {
                setLoading(false);
            }
        }

        // Add a message to the chat
        function addMessage(type, content, responseTime = null, suggestedQuestion = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message--${type}`;

            let html = `<div class="message__content">${escapeHtml(content)}</div>`;

            if (type === 'ai' && responseTime) {
                html += `<div class="message__meta">Response time: ${(responseTime / 1000).toFixed(1)}s</div>`;
            }

            if (type === 'ai' && suggestedQuestion) {
                html += `
                    <div class="suggested">
                        <div class="suggested__label">Suggested follow-up:</div>
                        <button class="suggested__button" onclick="sendQuestion('${escapeHtml(suggestedQuestion)}')">${escapeHtml(suggestedQuestion)}</button>
                    </div>
                `;
            }

            messageDiv.innerHTML = html;
            messages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add loading indicator
        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading-indicator';

            const randomFact = QUANTUM_FACTS[Math.floor(Math.random() * QUANTUM_FACTS.length)];

            loadingDiv.innerHTML = `
                <div class="loading__animation">
                    <div class="atom atom--animated">
                        <div class="atom__nucleus"></div>
                        <div class="atom__orbit atom__orbit--1">
                            <div class="atom__electron"></div>
                        </div>
                        <div class="atom__orbit atom__orbit--2">
                            <div class="atom__electron"></div>
                        </div>
                        <div class="atom__orbit atom__orbit--3">
                            <div class="atom__electron"></div>
                        </div>
                    </div>
                </div>
                <div class="loading__content">
                    <div class="loading__status">
                        <span class="loading__message" id="loading-message">${LOADING_MESSAGES[0]}</span>
                        <span class="loading__dots" id="loading-dots"></span>
                    </div>
                    <div class="loading__fact">
                        <span class="loading__fact-label">Did you know?</span>
                        <span class="loading__fact-text" id="loading-fact">${randomFact}</span>
                    </div>
                    <div class="loading__patience">
                        Please wait, this typically takes 40-90 seconds on our free-tier server.
                    </div>
                </div>
            `;

            messages.appendChild(loadingDiv);
            scrollToBottom();

            // Start animations
            startLoadingAnimations();

            return loadingDiv;
        }

        // Loading animation intervals
        let messageInterval, factInterval, dotsInterval;

        function startLoadingAnimations() {
            let messageIndex = 0;
            let dotsCount = 0;

            // Rotate messages every 3 seconds
            messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % LOADING_MESSAGES.length;
                const el = document.getElementById('loading-message');
                if (el) el.textContent = LOADING_MESSAGES[messageIndex];
            }, 3000);

            // Rotate facts every 8 seconds
            factInterval = setInterval(() => {
                const factEl = document.getElementById('loading-fact');
                if (factEl) {
                    const randomFact = QUANTUM_FACTS[Math.floor(Math.random() * QUANTUM_FACTS.length)];
                    factEl.textContent = randomFact;
                }
            }, 8000);

            // Animate dots every 500ms
            dotsInterval = setInterval(() => {
                dotsCount = (dotsCount + 1) % 4;
                const dotsEl = document.getElementById('loading-dots');
                if (dotsEl) dotsEl.textContent = '.'.repeat(dotsCount);
            }, 500);
        }

        function stopLoadingAnimations() {
            clearInterval(messageInterval);
            clearInterval(factInterval);
            clearInterval(dotsInterval);
        }

        // Set loading state
        function setLoading(loading) {
            isLoading = loading;
            inputField.disabled = loading;
            sendBtn.disabled = loading;

            if (!loading) {
                stopLoadingAnimations();
            }
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chat.scrollTop = chat.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
