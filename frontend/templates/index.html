<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Computing Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Quantum Computing Assistant</h1>
            <p>Powered by a custom 125.8M parameter transformer</p>
        </header>

        <div class="chat" id="chat">
            <!-- Welcome screen (shown initially) -->
            <div class="welcome" id="welcome">
                <div class="welcome__icon">
                    <div class="atom">
                        <div class="atom__nucleus"></div>
                        <div class="atom__orbit atom__orbit--1"></div>
                        <div class="atom__orbit atom__orbit--2"></div>
                        <div class="atom__orbit atom__orbit--3"></div>
                    </div>
                </div>
                
                <h2 class="welcome__title">Welcome!</h2>
                
                <p class="welcome__text">
                    Ask me anything about quantum computing. I'm here to help explain 
                    concepts like qubits, superposition, entanglement, and more.
                </p>

                <div class="welcome__disclaimer">
                    <strong>⚠️ Please note:</strong> This app runs on a free-tier server with a 
                    custom 125.8M parameter model running on CPU. Response times are typically 
                    <strong>40-90 seconds</strong>. Thank you for your patience!
                </div>

                <div class="welcome__starters">
                    <p class="welcome__starters-label">Try one of these questions:</p>
                    <div class="welcome__starters-grid">
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is a qubit?')">What is a qubit?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is superposition?')">What is superposition?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is quantum entanglement?')">What is quantum entanglement?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('What is a quantum gate?')">What is a quantum gate?</button>
                        <button class="welcome__starter-btn" onclick="sendQuestion('Why is quantum computing important?')">Why is quantum computing important?</button>
                    </div>
                </div>
            </div>

            <!-- Messages container (hidden initially) -->
            <div class="messages" id="messages"></div>
        </div>

        <form class="input-bar" id="input-form" onsubmit="handleSubmit(event)">
            <div class="input-bar__loader" id="input-loader">
                <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading" class="loading__gif" id="loading-gif">
                <canvas class="loading__canvas" id="loading-canvas" style="display: none;"></canvas>
            </div>
            <div class="input-bar__row">
                <input
                    type="text"
                    class="input-bar__input"
                    id="input-field"
                    placeholder="Ask a question about quantum computing..."
                    autocomplete="off"
                >
                <button type="submit" class="input-bar__button" id="send-btn">Send</button>
            </div>
        </form>
    </div>

    <script>
        // State
        let isLoading = false;
        let hasMessages = false;
        let gifShown = false;

        // Actual pipeline steps with approximate timings (in seconds)
        const PIPELINE_STEPS = [
            { text: "Embedding your question with Voyage AI", duration: 11 },
            { text: "Searching knowledge base (28,071 Q&A pairs)", duration: 11 },
            { text: "Retrieved relevant context from Neon database", duration: 11 },
            { text: "Ranking results by relevance", duration: 11 },
            { text: "Building prompt with context", duration: 11 },
            { text: "Loading 125.8M parameter model", duration: 11 },
            { text: "Generating response", duration: 60 }
        ];

        // DOM elements
        const chat = document.getElementById('chat');
        const welcome = document.getElementById('welcome');
        const messages = document.getElementById('messages');
        const inputField = document.getElementById('input-field');
        const sendBtn = document.getElementById('send-btn');
        const inputLoader = document.getElementById('input-loader');
        const loadingGif = document.getElementById('loading-gif');
        const loadingCanvas = document.getElementById('loading-canvas');

        // Handle form submission
        function handleSubmit(event) {
            event.preventDefault();
            const question = inputField.value.trim();
            if (question && !isLoading) {
                sendQuestion(question);
                inputField.value = '';
            }
        }

        // Handle suggested question button click
        function handleSuggestedClick(button, question) {
            // Hide the button's container
            button.parentElement.style.display = 'none';
            sendQuestion(question);
        }

        // Hide any suggested buttons that match the question
        function hideSuggestedButtons(question) {
            const buttons = document.querySelectorAll('.suggested__button');
            buttons.forEach(btn => {
                if (btn.textContent.trim().toLowerCase() === question.trim().toLowerCase()) {
                    btn.parentElement.style.display = 'none';
                }
            });
        }

        // Send a question to the API
        async function sendQuestion(question) {
            if (isLoading) return;

            // Hide any matching suggested buttons
            hideSuggestedButtons(question);

            // Hide welcome, show messages
            if (!hasMessages) {
                welcome.style.display = 'none';
                messages.style.display = 'flex';
                hasMessages = true;
            }

            // Add user message
            addMessage('user', question);

            // Show loading
            setLoading(true);
            const loadingEl = addLoadingIndicator();

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                // Remove loading indicator
                loadingEl.remove();

                if (response.ok) {
                    addMessage('ai', data.answer, data.response_time_ms, data.suggested_question);
                } else {
                    addMessage('error', data.error || 'Something went wrong. Please try again.');
                }
            } catch (error) {
                loadingEl.remove();
                addMessage('error', 'Failed to connect. Is the backend running?');
            } finally {
                setLoading(false);
            }
        }

        // Add a message to the chat
        function addMessage(type, content, responseTime = null, suggestedQuestion = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message--${type}`;

            if (type === 'ai') {
                // For AI messages, use typing effect
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message__content';
                messageDiv.appendChild(contentDiv);

                // Add meta and suggested question containers (hidden until typing done)
                let metaDiv = null;
                let suggestedDiv = null;

                if (responseTime) {
                    metaDiv = document.createElement('div');
                    metaDiv.className = 'message__meta';
                    metaDiv.style.opacity = '0';
                    metaDiv.textContent = `Response time: ${(responseTime / 1000).toFixed(1)}s`;
                    messageDiv.appendChild(metaDiv);
                }

                if (suggestedQuestion) {
                    suggestedDiv = document.createElement('div');
                    suggestedDiv.className = 'suggested';
                    suggestedDiv.id = `suggested-${Date.now()}`;
                    suggestedDiv.style.opacity = '0';
                    suggestedDiv.innerHTML = `<button class="suggested__button" onclick="handleSuggestedClick(this, '${escapeHtml(suggestedQuestion)}')">${escapeHtml(suggestedQuestion)}</button>`;
                    messageDiv.appendChild(suggestedDiv);
                }

                messages.appendChild(messageDiv);
                scrollToBottom();

                // Type out the content
                typeText(contentDiv, content, () => {
                    // Show meta and suggested after typing completes
                    if (metaDiv) {
                        metaDiv.style.transition = 'opacity 0.3s ease';
                        metaDiv.style.opacity = '1';
                    }
                    if (suggestedDiv) {
                        suggestedDiv.style.transition = 'opacity 0.3s ease';
                        suggestedDiv.style.opacity = '1';
                    }
                    // Pause GIF after typing is done
                    pauseGif();
                });
            } else {
                // For user/error messages, show immediately
                let html = `<div class="message__content">${escapeHtml(content)}</div>`;
                messageDiv.innerHTML = html;
                messages.appendChild(messageDiv);
                scrollToBottom();
                
                // Pause GIF for error messages
                if (type === 'error') {
                    pauseGif();
                }
            }
        }

        // Typing effect function
        function typeText(element, text, onComplete) {
            let index = 0;
            const speed = 15; // milliseconds per character

            function type() {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                    scrollToBottom();
                    setTimeout(type, speed);
                } else {
                    if (onComplete) onComplete();
                }
            }

            type();
        }

        // Add loading indicator
        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading-indicator';

            loadingDiv.innerHTML = `
                <div class="loading__bubble" id="loading-bubble">
                    <span class="loading__message" id="loading-message">${PIPELINE_STEPS[0].text}</span><span class="loading__dots-text" id="loading-dots-text"></span>
                </div>
                <div class="loading__patience">
                    This typically takes 40-90 seconds on our free-tier CPU server.
                </div>
            `;

            messages.appendChild(loadingDiv);
            scrollToBottom();

            // Show and play GIF animation
            showGif();
            playGif();

            // Start stepping through pipeline
            startLoadingAnimations();

            return loadingDiv;
        }

        // Show the GIF loader area
        function showGif() {
            inputLoader.classList.add('input-bar__loader--visible');
            gifShown = true;
        }

        // Play GIF animation (reload to restart, show img, hide canvas)
        function playGif() {
            const src = loadingGif.src;
            loadingGif.src = '';
            loadingGif.src = src;
            loadingGif.style.display = 'block';
            loadingCanvas.style.display = 'none';
        }

        // Pause GIF animation (capture to canvas, show canvas, hide img)
        function pauseGif() {
            if (!gifShown) return;
            
            loadingCanvas.width = loadingGif.naturalWidth || loadingGif.width;
            loadingCanvas.height = loadingGif.naturalHeight || loadingGif.height;
            
            const ctx = loadingCanvas.getContext('2d');
            ctx.drawImage(loadingGif, 0, 0);
            
            loadingCanvas.style.display = 'block';
            loadingGif.style.display = 'none';
        }

        // Loading animation intervals
        let stepTimeouts = [];
        let dotsInterval = null;

        function startLoadingAnimations() {
            let elapsed = 0;
            
            // Schedule each step based on its duration with fade transition
            PIPELINE_STEPS.forEach((step, index) => {
                if (index === 0) return; // First step shown immediately
                
                elapsed += PIPELINE_STEPS[index - 1].duration * 1000;
                
                const timeout = setTimeout(() => {
                    const messageEl = document.getElementById('loading-message');
                    const dotsEl = document.getElementById('loading-dots-text');
                    
                    if (messageEl) {
                        // Fade out text only
                        messageEl.style.opacity = '0';
                        if (dotsEl) dotsEl.style.opacity = '0';
                        
                        // Change text and fade in after fade out completes
                        setTimeout(() => {
                            messageEl.textContent = step.text;
                            messageEl.style.opacity = '1';
                            if (dotsEl) dotsEl.style.opacity = '1';
                        }, 400);
                    }
                }, elapsed);
                
                stepTimeouts.push(timeout);
            });

            // Animate dots (0, 1, 2, 3, repeat)
            let dotsCount = 0;
            dotsInterval = setInterval(() => {
                const dotsEl = document.getElementById('loading-dots-text');
                if (dotsEl) {
                    dotsEl.textContent = '.'.repeat(dotsCount);
                    dotsCount = (dotsCount + 1) % 4;
                }
            }, 400);
        }

        function stopLoadingAnimations() {
            stepTimeouts.forEach(timeout => clearTimeout(timeout));
            stepTimeouts = [];
            if (dotsInterval) {
                clearInterval(dotsInterval);
                dotsInterval = null;
            }
        }

        // Set loading state
        function setLoading(loading) {
            isLoading = loading;
            inputField.disabled = loading;
            sendBtn.disabled = loading;

            if (!loading) {
                stopLoadingAnimations();
                // GIF stays visible, will be paused after typing completes
            }
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chat.scrollTop = chat.scrollHeight;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
